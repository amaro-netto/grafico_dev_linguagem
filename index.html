<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status de Linguagens GitHub</title>
    <!-- Não precisamos mais do Chart.js aqui, pois a imagem vem do servidor -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
    <style>
        /* Define que HTML e BODY ocupem 100% da altura da viewport e remove margens/paddings padrão */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* Estilos para o corpo da página, centralizando o conteúdo */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column; /* Para empilhar os containers verticalmente */
            justify-content: flex-start; /* Alinha o conteúdo ao topo */
            align-items: center;
            background-color: #f0f2f5; /* Cor de fundo suave */
            padding: 20px 0; /* Adiciona um pouco de padding vertical para não colar nas bordas */
            min-height: 100vh; /* Garante que o body ocupe a altura total da tela */
        }

        /* Contêiner principal do gráfico e dos controles */
        .chart-container {
            width: 80%; /* Largura responsiva */
            max-width: 600px; /* Largura máxima para desktop */
            background-color: #fff; /* Fundo branco */
            padding: 20px;
            border-radius: 8px; /* Cantos arredondados */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Sombra suave */
            display: flex; /* Usa flexbox para organização interna */
            flex-direction: column; /* Elementos empilhados verticalmente */
            align-items: center; /* Centraliza horizontalmente os itens */
            box-sizing: border-box; /* Garante que padding e borda não aumentem o tamanho total */
            text-align: center; /* Centraliza o texto */
            margin-bottom: 20px; /* Adiciona margem abaixo do container do gráfico */
        }

        /* Estilo para a imagem do gráfico (agora será uma <img>) */
        #linguagensRadarImage { /* ID modificado para imagem */
            width: 100%;
            max-width: 500px; /* Tamanho máximo da imagem */
            height: auto;
            margin-top: 15px;
            display: none; /* Escondido por padrão */
        }

        /* Estilo para o campo de entrada do nome de usuário */
        #github-username {
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 70%;
            max-width: 250px;
        }

        /* Estilo para o botão "Gerar Gráfico" */
        button {
            padding: 10px 15px;
            background-color: #007bff; /* Azul vibrante */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer; /* Indica que é clicável */
            font-size: 16px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease; /* Transição suave no hover */
        }

        button:hover {
            background-color: #0056b3; /* Azul mais escuro no hover */
        }

        /* Estilos para mensagens de carregamento e erro */
        #loading-message, #error-message {
            margin-top: 10px;
            font-style: italic;
            color: #555;
            display: none; /* Escondido por padrão */
            word-break: break-word; /* Quebra palavras longas para evitar overflow */
        }

        #error-message {
            color: red; /* Mensagens de erro em vermelho */
        }

        /* Contêiner para a saída do código Markdown - AGORA É UM CONTÊINER SEPARADO */
        #markdown-output {
            width: 80%; /* Largura responsiva, igual ao chart-container */
            max-width: 600px; /* Largura máxima, igual ao chart-container */
            background-color: #fff; /* Fundo branco */
            padding: 20px;
            border-radius: 8px; /* Cantos arredondados */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Sombra suave */
            display: none; /* Escondido por padrão */
            text-align: center; /* Centraliza o texto */
        }

        /* Estilo para a área de texto do código Markdown */
        #markdown-code {
            width: 100%; /* Ocupa a largura total do pai */
            resize: vertical; /* Permite redimensionamento vertical */
        }

        /* Estilo para o aviso de Base64 */
        .base64-warning {
            color: orange;
            font-size: 0.9em;
            margin-top: 10px;
            text-align: left;
        }

        /* Estilo para a seção de outras linguagens */
        #other-languages-output {
            margin-top: 15px;
            font-size: 0.9em;
            color: #666;
            text-align: center; /* Centraliza as tags */
            display: none; /* Escondido por padrão */
            width: 100%; /* Ocupa a largura total para centralizar */
        }

        #other-languages-output span {
            display: inline-block; /* Tags lado a lado */
            background-color: #e0e0e0;
            border-radius: 4px;
            padding: 3px 8px;
            margin: 2px; /* Margem menor para ficarem mais próximas */
            white-space: nowrap; /* Evita quebras de linha dentro da tag */
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h1>Minhas Linguagens GitHub</h1>
        <input type="text" id="github-username" placeholder="Digite seu nome de usuário do GitHub">
        <button onclick="getGitHubLanguages()">Gerar Gráfico</button>
        <p id="loading-message">Gerando gráfico dinâmico...</p>
        <p id="error-message"></p>
        <!-- Onde a imagem do gráfico será exibida -->
        <img id="linguagensRadarImage" alt="Gráfico de Linguagens GitHub">

        <!-- Seção para exibir outras linguagens (ainda vai ser preenchida pelo JS, mas de forma simplificada) -->
        <div id="other-languages-output">
        </div>
    </div>

    <!-- A seção markdown-output agora está FORA do chart-container -->
    <div id="markdown-output">
        <h3>Código Markdown para seu README.md:</h3>
        <p class="base64-warning">
            **Atenção:** A URL abaixo aponta para sua função serverless no Vercel, que gera o gráfico dinamicamente.
        </p>
        <textarea id="markdown-code" rows="4" cols="50" readonly></textarea>
        <button onclick="copyMarkdown()">Copiar Código</button>
    </div>

    <!-- O script JavaScript é colocado aqui, antes do fechamento do </body>,
         para garantir que todos os elementos HTML e bibliotecas externas (Chart.js)
         já foram carregados e estejam disponíveis. -->
    <script>
        // IMPORTANTE: COLOQUE A URL DO SEU PROJETO IMPLANTADO NO VERCEL AQUI
        // Exemplo: 'https://seu-projeto-vercel.vercel.app'
        const VERCEL_PROJECT_URL = 'https://grafdev.vercel.app'; // <--- SUA URL REAL DO VERCEL

        /**
         * Função para obter um parâmetro da URL.
         * @param {string} param - O nome do parâmetro a ser buscado.
         * @returns {string|null} O valor do parâmetro ou null se não encontrado.
         */
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        /**
         * Função principal para gerar a URL da imagem do gráfico e exibi-la.
         * Esta função NÃO faz requisições diretas à API do GitHub.
         * Ela apenas constrói a URL para a função serverless do Vercel.
         * @param {string|null} usernameFromParam - Nome de usuário passado via parâmetro de URL, se houver.
         */
        async function getGitHubLanguages(usernameFromParam = null) {
            const usernameInput = document.getElementById('github-username');
            const username = usernameFromParam || usernameInput.value.trim();

            const loadingMessage = document.getElementById('loading-message');
            const errorMessage = document.getElementById('error-message');
            const markdownOutput = document.getElementById('markdown-output');
            const markdownCode = document.getElementById('markdown-code');
            const linguagensRadarImage = document.getElementById('linguagensRadarImage'); // Referência à nova <img>
            const otherLanguagesOutput = document.getElementById('other-languages-output');

            errorMessage.style.display = 'none';
            errorMessage.textContent = '';
            markdownOutput.style.display = 'none';
            linguagensRadarImage.style.display = 'none'; // Esconde a imagem
            otherLanguagesOutput.style.display = 'none';
            otherLanguagesOutput.innerHTML = '';

            if (!username) {
                errorMessage.textContent = 'Por favor, digite um nome de usuário do GitHub.';
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                return;
            }

            loadingMessage.style.display = 'block';

            try {
                // Constrói a URL para a sua função serverless do Vercel
                const imageUrl = `${VERCEL_PROJECT_URL}/api/generate-chart?username=${username}`;

                // Define o src da imagem para carregar o gráfico da função serverless
                linguagensRadarImage.src = imageUrl;
                linguagensRadarImage.alt = `Gráfico de Linguagens GitHub para ${username}`;

                // Adiciona um listener para quando a imagem carregar (ou falhar)
                linguagensRadarImage.onload = () => {
                    loadingMessage.style.display = 'none';
                    linguagensRadarImage.style.display = 'block'; // Mostra a imagem
                    // Como a imagem vem do servidor, as tags de outras linguagens não são geradas aqui.
                    // Se você quiser tags, o servidor precisaria retornar esses dados junto com a imagem,
                    // ou você teria que fazer uma requisição separada para os dados brutos.
                    // Por simplicidade, para a imagem dinâmica, as tags extras não serão exibidas nesta versão.
                    otherLanguagesOutput.style.display = 'none'; // Garante que a seção de tags está escondida
                };

                linguagensRadarImage.onerror = () => {
                    loadingMessage.style.display = 'none';
                    errorMessage.textContent = 'Erro ao carregar o gráfico. Verifique o nome de usuário ou tente novamente mais tarde.';
                    errorMessage.style.display = 'block';
                    linguagensRadarImage.style.display = 'none';
                };

                // Geração do Código Markdown (agora muito mais curto!)
                const markdownCodeContent = `![Gráfico de Linguagens GitHub para ${username}](${imageUrl})`;
                markdownCode.value = markdownCodeContent;
                markdownOutput.style.display = 'block';

            } catch (error) {
                console.error('Erro ao gerar URL do gráfico:', error);
                errorMessage.textContent = `Erro: ${error.message}.`;
                errorMessage.style.display = 'block';
            } finally {
                // A mensagem de loading é escondida no onload/onerror da imagem
            }
        }

        /**
         * Função para copiar o código Markdown para a área de transferência.
         */
        function copyMarkdown() {
            const markdownCode = document.getElementById('markdown-code');
            markdownCode.select();
            markdownCode.setSelectionRange(0, 99999);
            document.execCommand('copy');
            alert('Código Markdown copiado para a área de transferência!');
        }

        // Executa quando a janela é completamente carregada
        window.onload = () => {
            const urlUsername = getQueryParam('username');
            if (urlUsername) {
                document.getElementById('github-username').value = urlUsername;
                getGitHubLanguages(urlUsername);
            }
        };
    </script>
</body>
</html>
